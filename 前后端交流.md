# 前后端对接文档 📡

> **项目**: 木头的状态监控系统 (sleepy-status)  
> **创建时间**: 2024-12-20  
> **最后更新**: 2024-12-20  

---

## 📋 更新日志

### 2024-12-20 (最新) - API接口全面优化
- **[前端]** 完善StatusCard组件API对接：增强错误处理、添加HTTP状态码检查
- **[前端]** 新增在线状态指示器：10分钟内有更新显示为在线，符合后端文档规范
- **[前端]** 改进DynamicTimeline组件：从模拟数据改为真实API调用(/history接口)
- **[前端]** 统一时间格式：DynamicTimeline与StatusCard使用相同的智能中文时间格式
- **[前端]** 增强错误处理：网络错误时显示友好提示，API响应格式验证
- **[前端]** 优化状态历史：StatusCard组件现在同时调用/history接口获取最新历史记录
- **[前端]** 添加系统通知：连接成功/失败时显示对应消息提示
- **[前端]** 视觉优化：离线用户显示灰度效果，在线状态有绿色脉冲动画

### 2024-12-20 (历史)
- **[前端]** 优化时间显示系统：智能中文相对时间格式
- **[前端]** 新增实时时间更新：自动刷新相对时间显示
- **[前端]** 统一时间格式：StatusCard和DynamicTimeline组件时间显示一致
- **[后端]** 修改睡觉逻辑：改为1小时无活动判断，取消基于时间段的睡觉判断
- **[后端]** 增加活动检测功能：窗口变化+鼠标位置监控
- **[前端]** 激活StatusCard组件的真实API调用
- **[前端]** 添加API错误处理和备用数据机制
- **[文档]** 明确API接口与用户的对应关系
- **[前端]** 完成双人模式页面更新
- **[前端]** 生日倒计时组件支持双人生日和30天逻辑
- **[前端]** 状态卡片组件支持双人状态显示
- **[前端]** 完成所有"林璐"到"木头"的替换
- **[前端]** 新增乾雨角色支持

---

## 🎯 系统概述

### 核心功能
- **双用户支持**: 木头 🐰 和 乾雨 🌧️
- **8种状态**: 睡觉、工作、运动、看B站、玩游戏、听音乐、学习、做饭
- **智能睡觉检测**: 1小时无活动自动切换为睡觉状态
- **自动监控**: 桌面应用程序自动状态更新
- **跨平台**: 支持移动端控制面板

### 服务器信息
- **地址**: `http://127.0.0.1:5000`
- **认证**: 密钥认证 (默认: `birthday2024`)
- **CORS**: 已启用跨域支持

---

## 🔌 API 接口文档

### 1. 获取系统信息
```
GET /
```
**响应示例:**
```json
{
  "message": "林璐的状态监控服务",
  "version": "1.0.0",
  "endpoints": {
    "/query": "获取当前状态",
    "/get/status_list": "获取状态列表",
    "/set": "设置状态 (需要secret参数)",
    "/history": "获取状态历史"
  }
}
```

### 2. 查询用户状态
```
GET /query?user={用户ID}
```
**参数:**
- `user` (可选): 用户ID，不传则返回所有用户

**📍 用户接口对应关系:**
- **木头**: `user=木头` 或省略参数获取所有用户中的木头信息
- **乾雨**: `user=乾雨` 或省略参数获取所有用户中的乾雨信息
- **前端调用**: 建议使用不带参数的 `/query` 获取所有用户状态

**单用户响应:**
```json
{
  "user": "木头",
  "display_name": "木头",
  "emoji": "🐰",
  "status": "2",
  "name": "工作中",
  "description": "正在努力工作",
  "color": "#3498DB",
  "last_update": "2024-12-20T14:30:00.000000",
  "timestamp": "2024-12-20T14:30:00.000000"
}
```

**多用户响应 (推荐前端使用):**
```json
{
  "users": {
    "木头": {
      "display_name": "木头",
      "emoji": "🐰",
      "status": "2",
      "name": "工作中",
      "description": "正在努力工作",
      "color": "#3498DB",
      "last_update": "2024-12-20T14:30:00.000000"
    },
    "乾雨": {
      "display_name": "乾雨",
      "emoji": "🌧️",
      "status": "1",
      "name": "睡觉中",
      "description": "正在做美梦zzz...",
      "color": "#9B59B6",
      "last_update": "2024-12-20T14:25:00.000000"
    }
  },
  "timestamp": "2024-12-20T14:30:00.000000"
}
```

### 3. 获取状态列表
```
GET /get/status_list
```
**响应示例:**
```json
{
  "status_list": {
    "1": {"name": "睡觉中", "desc": "正在做美梦zzz...", "color": "#9B59B6"},
    "2": {"name": "工作中", "desc": "正在努力工作", "color": "#3498DB"},
    "3": {"name": "运动中", "desc": "正在运动💪", "color": "#E74C3C"},
    "4": {"name": "看B站", "desc": "正在刷B站", "color": "#FF69B4"},
    "5": {"name": "玩游戏", "desc": "在游戏世界里", "color": "#F39C12"},
    "6": {"name": "听音乐", "desc": "正在享受音乐", "color": "#1ABC9C"},
    "7": {"name": "学习中", "desc": "在认真学习", "color": "#8E44AD"},
    "8": {"name": "做饭中", "desc": "在准备美食", "color": "#E67E22"}
  },
  "current": "2"
}
```

### 4. 设置用户状态
```
GET /set?secret={密钥}&status={状态ID}&user={用户ID}
```
**参数:**
- `secret` (必需): 认证密钥 (默认: `birthday2024`)
- `status` (必需): 状态ID (1-8)
- `user` (可选): 用户ID (默认: `木头`)

**📍 用户参数说明:**
- **木头**: `user=木头` 或省略参数（默认）
- **乾雨**: `user=乾雨`
- **自动监控**: 通过 auto_monitor.py 脚本可选择监控用户

**成功响应:**
```json
{
  "success": true,
  "message": "状态更新成功",
  "user": "木头",
  "display_name": "木头",
  "emoji": "🐰",
  "status": {
    "id": "2",
    "name": "工作中",
    "description": "正在努力工作",
    "color": "#3498DB"
  },
  "timestamp": "2024-12-20T14:30:00.000000"
}
```

**错误响应:**
```json
{
  "error": "密钥错误"
}
```

### 5. 获取状态历史
```
GET /history?user={用户ID}
```
**参数:**
- `user` (可选): 用户ID，不传则返回所有用户历史

**📍 用户历史对应关系:**
- **木头历史**: `user=木头`
- **乾雨历史**: `user=乾雨`
- **所有历史**: 不传参数

**响应示例:**
```json
{
  "history": [
    {
      "user": "木头",
      "display_name": "木头",
      "emoji": "🐰",
      "status_id": "2",
      "name": "工作中",
      "description": "正在努力工作",
      "color": "#3498DB",
      "timestamp": "2024-12-20T14:30:00.000000"
    }
  ],
  "total": 1,
  "filtered_user": "木头"
}
```

---

## 📊 数据结构定义

### 用户信息
```json
{
  "用户ID": {
    "display_name": "显示名称",
    "emoji": "用户emoji",
    "current_status": "当前状态ID",
    "last_update": "最后更新时间ISO格式"
  }
}
```

### 状态信息
```json
{
  "状态ID": {
    "name": "状态名称",
    "desc": "状态描述",
    "color": "颜色代码"
  }
}
```

### 状态与Emoji映射
| 状态ID | 状态名称 | Emoji | 颜色 |
|--------|----------|-------|------|
| 1      | 睡觉中   | 😴    | #9B59B6 |
| 2      | 工作中   | 💻    | #3498DB |
| 3      | 运动中   | 🏃‍♀️  | #E74C3C |
| 4      | 看B站    | 📱    | #FF69B4 |
| 5      | 玩游戏   | 🎮    | #F39C12 |
| 6      | 听音乐   | 🎵    | #1ABC9C |
| 7      | 学习中   | 📚    | #8E44AD |
| 8      | 做饭中   | 👩‍🍳  | #E67E22 |

---

## ⚠️ 错误处理

### 错误码说明
- **400**: 缺少必要参数
- **403**: 密钥错误
- **404**: 用户不存在或状态无效
- **500**: 服务器内部错误

### 常见错误示例
```json
{
  "error": "缺少必要参数",
  "required": ["secret", "status"],
  "optional": ["user"]
}
```

```json
{
  "error": "无效的状态ID",
  "valid_status": ["1", "2", "3", "4", "5", "6", "7", "8"]
}
```

---

## 🚀 使用示例

### JavaScript 示例
```javascript
// 获取所有用户状态（推荐）
async function getAllUsersStatus() {
  const response = await fetch('/query');
  const data = await response.json();
  return data.users; // { 木头: {...}, 乾雨: {...} }
}

// 获取特定用户状态
async function getUserStatus(user = '木头') {
  const response = await fetch(`/query?user=${user}`);
  const data = await response.json();
  return data;
}

// 设置状态
async function setStatus(statusId, user = '木头', secret = 'birthday2024') {
  const response = await fetch(`/set?secret=${secret}&status=${statusId}&user=${user}`);
  const data = await response.json();
  return data;
}

// 获取状态列表
async function getStatusList() {
  const response = await fetch('/get/status_list');
  const data = await response.json();
  return data;
}
```

### 前端轮询示例
```javascript
// 每30秒检查状态更新
setInterval(async () => {
  const usersStatus = await getAllUsersStatus();
  updateUI(usersStatus);
}, 30000);
```

---

## 🌐 现有页面

### 1. 状态展示页面
- **地址**: `/status_page`
- **功能**: 双用户状态实时展示
- **特色**: 自动30秒刷新

### 2. 移动端控制面板
- **地址**: `/mobile`
- **功能**: 移动端状态控制
- **特色**: 触摸友好、PWA支持

---

## ⏰ 时间显示系统

### 智能中文时间格式
系统采用智能的中文相对时间显示，提供直观的时间感知：

#### 时间格式规则
- **30秒内**: "刚刚"
- **1分钟内**: "X秒前"
- **1小时内**: "X分钟前"  
- **当天**: "X小时前"
- **昨天**: "昨天 HH:mm" 或 "昨天"
- **1周内**: "X天前"
- **1个月内**: "X周前"
- **1年内**: "X个月前"
- **超过1年**: "YYYY年M月D日"

#### 实时更新机制
- **更新频率**: 每30秒自动更新时间显示
- **组件覆盖**: StatusCard、DynamicTimeline组件
- **性能优化**: 前端计算，减少服务器请求

#### 实现位置
- **StatusCard组件**: 最后更新时间、历史记录时间
- **DynamicTimeline组件**: 动态时间线时间显示
- **统一格式**: 所有时间显示使用相同的格式化函数

---

## 🌐 前端实现状态

### 📱 页面组件更新

#### 1. BirthdayCountdown 组件
- **✅ 双人生日支持**: 木头(2003.7.16) 和 乾雨(2002.7.27)
- **✅ 30天倒计时逻辑**: 距离生日30天内显示倒计时，否则显示已出生天数
- **✅ 响应式设计**: 适配移动端和桌面端
- **✅ 动画效果**: 新增年龄显示的呼吸动画

#### 2. StatusCard 组件
- **✅ 双人状态显示**: 同时显示木头🐰和乾雨🌧️的状态
- **✅ 8种状态支持**: 完整支持后端定义的8种状态
- **✅ 真实API对接**: 已激活 `http://127.0.0.1:5000/query` 调用
- **✅ 增强错误处理**: HTTP状态码检查、网络错误友好提示
- **✅ 在线状态指示器**: 10分钟内更新显示在线，符合后端文档规范
- **✅ 状态动画**: 为学习和做饭状态新增专用动画
- **✅ 双人布局**: 响应式双栏布局，移动端自动切换垂直布局
- **✅ 智能时间显示**: 中文相对时间格式，30秒自动更新
- **✅ 历史记录优化**: 调用/history API获取真实历史记录
- **✅ 系统通知**: 连接状态、错误消息的友好提示
- **✅ 视觉优化**: 离线状态灰度效果，在线状态绿色脉冲动画

#### 3. DynamicTimeline 组件
- **✅ 真实API对接**: 从模拟数据改为调用 `/history` 接口
- **✅ 智能时间显示**: 与StatusCard统一的时间格式
- **✅ 实时更新**: 30秒自动刷新时间显示
- **✅ 中文时间格式**: 刚刚、X分钟前、X小时前、昨天等
- **✅ 数据处理**: 将后端历史数据转换为时间线格式
- **✅ 错误处理**: 网络错误时显示备用数据和重试功能
- **✅ 加载状态**: 友好的加载动画和空状态提示
- **✅ 用户信息显示**: 每个历史记录显示用户emoji和名称

#### 4. 主页面逻辑
- **✅ 双人生日判断**: 7月16日或7月27日都会触发生日模式
- **✅ 命名统一**: 所有"林璐"引用已替换为"木头"

### 🔗 API对接状态

#### 当前状态
- **✅ 完整API对接**: StatusCard调用 `/query`，DynamicTimeline调用 `/history`
- **✅ 增强错误处理**: HTTP状态码检查、响应格式验证、友好错误提示
- **✅ 在线状态判断**: 基于10分钟内更新的在线状态逻辑
- **✅ 双用户支持**: 正确处理木头和乾雨的状态数据
- **✅ 实时更新**: 30秒轮询获取最新状态和历史记录
- **✅ 数据转换**: 后端数据转换为前端显示格式

#### API调用示例
```javascript
// StatusCard.vue 中的状态查询
const response = await fetch('http://127.0.0.1:5000/query')
if (!response.ok) {
  throw new Error(`HTTP ${response.status}: ${response.statusText}`)
}
const data = await response.json()

// 处理双用户响应
if (data.users) {
  const mutouData = data.users.木头
  const qianyuData = data.users.乾雨
  // 更新UI并判断在线状态...
}

// DynamicTimeline.vue 中的历史查询
const historyResponse = await fetch('http://127.0.0.1:5000/history')
const historyData = await historyResponse.json()
// 转换为时间线格式...
```

### 🎨 用户体验优化

#### 视觉效果
- **用户标识**: 木头🐰 / 乾雨🌧️ emoji区分
- **状态动画**: 每种状态都有专属的CSS动画
- **呼吸效果**: 活跃状态的呼吸动画
- **颜色系统**: 8种状态对应不同的主题色
- **错误提示**: 网络错误时显示"连接服务器中..."
- **智能时间**: 中文相对时间显示，自动更新

#### 交互体验
- **实时更新**: 30秒轮询获取状态更新
- **响应式**: 完美适配手机和桌面设备
- **加载状态**: 友好的加载提示和错误处理
- **备用数据**: 网络错误时显示缓存或备用状态
- **时间感知**: 自动更新相对时间，无需手动刷新

---

## 🔄 自动监控说明

### 新的睡觉检测机制 (已更新)
- **智能检测**: 不再基于时间段，改为活动检测
- **检测方式**: 
  - 窗口变化监控
  - 鼠标位置监控
  - 应用程序活动监控
- **判断逻辑**: 1小时（60分钟）无任何活动自动切换为睡觉状态
- **活动恢复**: 一旦检测到活动，立即切换回相应状态

### 应用程序映射
系统会自动监控以下应用程序：
- **开发工具**: VS Code, PyCharm, IntelliJ IDEA, Cursor → 工作中
- **游戏**: Steam, 原神, 英雄联盟 → 玩游戏
- **音乐**: 网易云音乐, Spotify → 听音乐
- **视频**: B站桌面版, PotPlayer → 看B站
- **学习**: Anki, Obsidian, Notion → 学习中

### 浏览器特殊处理
- 检测浏览器标题关键词
- 根据内容自动判断状态
- 支持 Chrome, Firefox, Edge, Brave

### 用户选择
- **监控启动**: 运行 `auto_monitor.py` 时可选择监控用户
- **木头**: 选择 [1] 🐰 木头
- **乾雨**: 选择 [2] 🌧️ 乾雨
- **独立监控**: 每个用户需要独立运行监控脚本

---

## 📝 前后端交流区

### 🎯 前端需求 (已完成)
- [x] **[前端]** 确认需要哪些额外的API接口 - 当前接口已满足需求
- [x] **[前端]** 确认数据格式是否满足需求 - 已按后端文档实现
- [x] **[前端]** 双人模式页面更新 - 已完成
- [x] **[前端]** 激活真实API调用 - 已完成
- [x] **[前端]** 状态历史记录显示优化 - 已完成用户信息显示
- [x] **[前端]** 错误处理和离线状态提示 - 已完成备用数据机制
- [x] **[前端]** 时间显示系统优化 - 已完成智能中文时间格式

### 🔧 后端优化 (已完成)
- [x] **[后端]** 智能睡觉检测 - 已完成1小时无活动检测
- [x] **[后端]** 活动监控优化 - 已完成窗口+鼠标位置监控
- [x] **[后端]** 双用户支持确认 - 已确认工作正常

### 💡 功能扩展想法
- [x] **[前端]** 双人模式状态显示 - 已完成
- [x] **[前端]** 生日倒计时30天逻辑 - 已完成
- [x] **[系统]** 智能睡觉检测机制 - 已完成
- [x] **[前端]** 智能时间显示系统 - 已完成
- [ ] **[讨论]** 添加状态分享功能
- [ ] **[讨论]** 添加状态预约功能
- [ ] **[讨论]** 添加状态趋势分析
- [ ] **[讨论]** 添加多设备同步支持
- [ ] **[讨论]** 状态变化时的动画过渡效果
- [ ] **[讨论]** 用户状态互动功能（如点赞、评论）
- [ ] **[讨论]** 状态持续时间统计
- [ ] **[讨论]** 双人状态对比和分析
- [ ] **[讨论]** 手机端状态检测（Apple Watch睡眠监测等）

---

## 📞 联系方式

### 问题反馈
- 后端问题: 直接修改此文档的"🔧 后端优化建议"部分
- 前端问题: 直接修改此文档的"🎯 前端需求"部分
- 讨论建议: 在"💡 功能扩展想法"部分添加

### 更新规范
1. **每次更新请在顶部更新日志记录**
2. **使用标签标识更新者**: `[后端]` `[前端]` `[讨论]` `[系统]`
3. **重要变更请在对应章节详细说明**
4. **删除已完成的待办事项**

---

## 🏠 相关文件

### 后端文件
- `sleepy-status/app.py` - Flask API服务器
- `sleepy-status/auto_monitor.py` - 自动监控脚本（已更新睡觉逻辑）
- `sleepy-status/data.json` - 状态数据存储
- `sleepy-status/history.json` - 状态历史记录

### 前端文件
- `birthday-website/pages/index.vue` - 主页面，生日判断逻辑
- `birthday-website/components/BirthdayCountdown.vue` - 双人生日倒计时组件
- `birthday-website/components/StatusCard.vue` - 双人状态监控组件（完整API对接+在线状态）
- `birthday-website/components/DynamicTimeline.vue` - 动态时间线组件（真实历史API对接）
- `birthday-website/components/InteractiveZone.vue` - 互动区域组件
- `birthday-website/components/LoveTimer.vue` - 恋爱时光机组件

---

**最后更新时间**: 2024-12-20 20:00:00  
**文档版本**: v1.4.0 - API接口全面优化版 